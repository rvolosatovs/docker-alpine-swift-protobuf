#!/bin/bash


if [ "$#" -ne 1 ]; then
    echo 'usage: docker run ... PROTOC-GEN-SWIFT-VERSION'
    exit 1
fi

set -xe

VERSION=${1:-upstream}

cd /root
rm -fr *
if [ "$VERSION" == "upstream" ]; then
	git clone https://github.com/grpc/grpc-swift.git
	cd grpc-swift
	VERSION=$(git rev-parse --short HEAD)
else
	curl -Ls https://github.com/grpc/grpc-swift/archive/$VERSION.tar.gz | tar xvz
	cd grpc-swift-$VERSION
fi

#swift build -Xswiftc -static-stdlib -v -c release -Xlinker '-L/usr/lib/swift/linux/'
cd Plugin 
make

mkdir -p export-lib/usr/lib/protoc-gen-swift-lib
mkdir -p export-lib/lib64
mkdir -p export-lib/usr/bin

for lib in `ldd protoc-gen-swift | cut -d'>' -f2 | awk '{print $1}'` ; do    if [ -f "$lib" ] ; then cp -v "$lib" export-lib/usr/lib/protoc-gen-swift-lib;    fi  ; done
for lib in `ldd protoc-gen-swiftgrpc | cut -d'>' -f2 | awk '{print $1}'` ; do    if [ -f "$lib" ] ; then cp -v "$lib" export-lib/usr/lib/protoc-gen-swift-lib;    fi  ; done
mv export-lib/usr/lib/protoc-gen-swift-lib/ld-linux-x86-64.so.2 export-lib/lib64
mv protoc-gen-swift export-lib/usr/bin
mv protoc-gen-swiftgrpc export-lib/usr/bin
cd export-lib && tar cvf export-lib-$VERSION.tar *
mv export-lib-$VERSION.tar /export

echo $VERSION
